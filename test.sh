#!/bin/bash

EMAIL_SVC=:8080
USER_SVC=:8081
COURSE_SVC=:8082
HOMEWORK_SVC=:8083

DB_HOST=localhost
DB_PORT=5432
DB_NAME=d
DB_USER=u
DB_PASS=p
DB_TABLES='person course assignment solution'
DB_IMPORTS='user-service course-service'

hit() {
    cmd="http  --pretty=none"
    for arg in "$@"; do
        cmd="$cmd \"$arg\""
    done
    echo -e "--> $cmd\n"
    res=$(eval "$cmd" | head -n 1)
    echo -e "<-- $res\n"
}

assert() {
    diff <(echo "$res") <(echo "$1")
    if [[ "$?" != 0 ]]; then
        echo 'Assertion failed'
        exit 1
    fi
}

# Clear SQL tables and re-import mock data.
export PGPASSWORD="$DB_PASS"
for table in $(echo $DB_TABLES); do
    psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "TRUNCATE $table RESTART IDENTITY CASCADE;"
done
for svc in $(echo $DB_IMPORTS); do
    psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -f "$svc/src/main/resources/import.sql"
done

echo "----------------------------------------------------------------------------------------------------------------"
echo " Get a teacher's JWT."
echo "----------------------------------------------------------------------------------------------------------------"
hit POST "$USER_SVC/auth/login" email=john@doe.io pass=heslo123
auth_teacher="Authorization: Bearer $res"
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Get another teacher's JWT."
echo "----------------------------------------------------------------------------------------------------------------"
hit POST "$USER_SVC/auth/login" email=farnsworth@planetexpress.com pass=heslo123
auth_teacher2="Authorization: Bearer $res"
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Get a student's JWT."
echo "----------------------------------------------------------------------------------------------------------------"
hit POST "$USER_SVC/auth/login" email=alice@bob.io pass=heslo123
auth_student="Authorization: Bearer $res"
echo "----------------------------------------------------------------------------------------------------------------"


echo "----------------------------------------------------------------------------------------------------------------"
echo "Get courses as a teacher."
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$COURSE_SVC/courses" "$auth_teacher"
assert '[{"id":1,"name":"Service Oriented Architecture","studentIds":[]}]'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Get courses as a student."
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$COURSE_SVC/courses" "$auth_student"
assert '[]'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Change the course's name."
echo "----------------------------------------------------------------------------------------------------------------"
hit PATCH "$COURSE_SVC/courses/1" name=SOA "$auth_teacher"
assert '{"id":1,"name":"SOA","studentIds":[]}'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Get user 1 as a teacher."
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$USER_SVC/users/1" "$auth_teacher"
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo " Publish an assignment."
echo "----------------------------------------------------------------------------------------------------------------"
hit POST "$HOMEWORK_SVC/assignments" courseId=1 description='Do something.' "$auth_teacher"
assert '{"id":1,"teacherId":1,"courseId":1,"description":"Do something."}'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo " Check the assignment's persistence."
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$HOMEWORK_SVC/assignments" "$auth_teacher"
assert '[{"id":1,"teacherId":1,"courseId":1,"description":"Do something."}]'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Check that another teacher cannot see the assignment"
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$HOMEWORK_SVC/assignments" "$auth_teacher2"
assert '[]'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Check that an unregistered student cannot see the assignment."
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$HOMEWORK_SVC/assignments" "$auth_student"
assert '[]'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Check the persistence of the changed name."
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$COURSE_SVC/courses" "$auth_teacher"
assert '[{"id":1,"name":"SOA","studentIds":[]}]'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Register a student for the course."
echo "----------------------------------------------------------------------------------------------------------------"
hit PATCH "$COURSE_SVC/courses/1" studentIds:=[2] "$auth_teacher"
assert '{"id":1,"name":"SOA","studentIds":[2]}'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Check the persistence of the student's registration."
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$COURSE_SVC/courses" "$auth_teacher"
assert '[{"id":1,"name":"SOA","studentIds":[2]}]'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Check that the student can now see the course."
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$COURSE_SVC/courses" "$auth_student"
assert '[{"id":1,"name":"SOA","studentIds":[2]}]'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Check that the student can now see the assignment."
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$HOMEWORK_SVC/assignments" "$auth_student"
assert '[{"id":1,"teacherId":1,"courseId":1,"description":"Do something."}]'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo " Publish a solution to an assignment."
echo "----------------------------------------------------------------------------------------------------------------"
hit POST "$HOMEWORK_SVC/solutions" content="This is a solution." assignmentId=1 "$auth_student"
assert '{"id":1,"content":"This is a solution.","assignmentId":1,"studentId":2,"mark":"NA","isOriginal":true}'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Check that student can see his own solution."
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$HOMEWORK_SVC/solutions" "$auth_teacher"
assert '[{"id":1,"content":"This is a solution.","assignmentId":1,"studentId":2,"mark":"NA","isOriginal":true}]'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Check that teacher that posted the assignment can this solution."
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$HOMEWORK_SVC/solutions" "$auth_teacher"
assert '[{"id":1,"content":"This is a solution.","assignmentId":1,"studentId":2,"mark":"NA","isOriginal":true}]'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Check that another teacher can not see the solutions"
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$HOMEWORK_SVC/solutions" "$auth_teacher2"
assert '[]'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo " Publish a PLAGIATE solution to an assignment."
echo "----------------------------------------------------------------------------------------------------------------"
hit POST "$HOMEWORK_SVC/solutions" content="Not stolen." assignmentId=1 "$auth_student"
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Check solutions"
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$HOMEWORK_SVC/solutions" "$auth_teacher"
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Check for plagiates"
echo "----------------------------------------------------------------------------------------------------------------"
hit GET "$HOMEWORK_SVC/solutions/plagiates" "$auth_teacher"
assert '[{"id":2,"content":"Not stolen.","assignmentId":1,"studentId":2,"mark":"NA","isOriginal":false}]'
echo "----------------------------------------------------------------------------------------------------------------"

echo "----------------------------------------------------------------------------------------------------------------"
echo "Mark published solution"
echo "----------------------------------------------------------------------------------------------------------------"
hit PATCH "$HOMEWORK_SVC/solutions/1" mark="A" "$auth_teacher"
assert '{"id":1,"content":"This is a solution.","assignmentId":1,"studentId":2,"mark":"A","isOriginal":true}'
echo "----------------------------------------------------------------------------------------------------------------"



echo 'Everything ok!'
